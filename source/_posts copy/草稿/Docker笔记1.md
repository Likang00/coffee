---
title: Docker笔记1
date: 2019-01-18 12:00:00
categories: Docker
tags: ["Docker","服务器"]
---

# 云服务器入门
###### 购买了腾讯云的云服务器，开始学习如何将代码部署到服务器上，这里使用了Docker(一个应用容器引擎)来管理和发布。
###### 使用的SSH终端为Xshell6(或者PuTTY)。
###### 还可以用WinSCP互传文件。
###### 重点记录Docker的使用。


![avatar](docker01.jpg)
### Docker
### [针对CentOS7.5]
#### 安装
yum install -y docker # 安装docker
systemctl start docker # 启动docker
docker search python
docker pull python
```
- systemctl docker start 
- systemctl docker restart 
- systemctl docker stop
```
#### 核心命令
docker images 查看镜像
docker ps 查看正在运行的容器
docker ps -a 查看所有容器

#### 开始制作镜像 [以配置sanic环境为例]
##### 1创建
docker run -it python "/bin/bash"
```
python -V
pip -V
pip list
pip install sanic
exit
```
docker commit xxxxxxxxxxxx sanic:latest
##### 2更新
docker run -it sanic
```
pip install sanic-motor
exit
```
docker commit xxxxxxxxxxxx sanic 会覆盖原本镜像
##### 
##### 备注 Docker commit
```
docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]
options说明
-a:提交的镜像作者
-c:使用Dockerfile指令来创建镜像
-m:提交时的说明文字
-p:在commit时，将容器暂停
# test
runoob@runoob:~$ docker commit -a "runoob.com" -m "my apache" a404c6c174a2  mymysql:v1 
sha256:37af1236adef1544e8886be23010b66577647a40bc02c0885a6600b33ee28057
```

#### test [部署main.py文件]
##### 1 docker命令行启动容器
mkdir /var/local/myproject
cd /var/local/myproject/
vim main.py
vim Dockerfile # 关键
docker build -t zlktest .
docker run -d --name=zlktest -p 80:8000 zlktest
```
# test
docker run --name quotation_api -itd -p 5000:5000 -v /home/quotation:/code quotation_dev:latest
--name为容器命名；
-itd  输入输出终端，后台运行
-p   host端口:容器端口    用5000是flask默认
-v  host路径:容器内路径
最后是使用的镜像名（前面刚用dockerfile build出来的）
```
##### 2 使用docker-compose命令部署
yum install -y docker-compose
cd /var/local/myproject/
touch docker-compose.yaml
docker-compose up -d

#### 删除相关的命令
docker rmi xxxxxxxxxxxx
docker rm -f xxxxxxxxxxxx

#### 更新代码后的部署
停止服务、删除容器
cd /var/local/myproject/
docker ps -a #查看容器名称
docker stop zlktest1
删除容器 zlktest1
更新main.py
docker build -it zlktest .
docker-compose up -d
这时删除过期镜像 [None]

#### 补充
##### [Dockerfile]
自动化image构建
```
FROM sanic
WORKDIR /zlk
COPY . .
CMD ["python","main.py"]
```
FROM {base镜像}:必须放在DOckerfile的第一行，表示从哪个baseimage开始构建
MAINTAINER:可选,标识image作者
[ADD&&COPY:](https://www.cnblogs.com/51kata/p/5264894.html "拷贝到镜像")
CMD：
　　CMD的作用是作为执行container时候的默认行为（容器默认的启动命令）
　　当运行container的时候声明了command，则不再用image中的CMD默认所定义的命令
　　一个Dockerfile中只能有一个有效的CMD，当定义多个CMD的时候，只有最后一个才会起作用
CMD定义的三种方式：
　　CMD <cmd> 这个会当作/bin/sh -c "cmd"来执行
　　CMD ["executable","arg1",....]
　　CMD ["arg1","arg2"]，这个时候CMD作为ENTRYPOINT的参数

---

```
Dockerfile语法
Dockerfile的指令是忽略大小写的，建议使用大写，使用 # 作为注释，每一行只支持一条指令

FROM： 目地：指定基础的image，表示新程序基于哪个image构建新image 语法： FROM <image>:<tag>tag：版本号，如果没有，则使用最新版本
MAINTAINER 指定镜像创建者信息 语法：MAINTAINER <name>
<!-- RUN RUN可以运行任何被基础image支持的命令 -->

WORKDIR 切换目录。可以多次切换工作目录(相当于cd命令)

ENV 在image中设置一个环境变量。

EXPOSE 指定容器需要映射到宿主机器的端口
    EXPOSE port1
    <==>
    docker run -p port1 image

    EXPOSE port1 port2 port3
    <==>
    docker run -p port1  -p port2 -p port3 image

VOLUME 指定挂载点.
运行通过该Dockerfile生成image的容器，/tmp/data目录中的数据在容器关闭后，里面的数据还存在

ADD 从src复制文件到容器的的dest路径
    ADD <src> <dest>
    <src> 源目录/文件
    <dest> 容器中的绝对路径

CMD
```
dockerfile:
http://baijiahao.baidu.com/s?id=1601896555302433815&wfr=spider&for=pc
https://www.cnblogs.com/boshen-hzb/p/6400272.html

---

```
简单的单机部署
python 环境搭建
Dockerfile

ENV PYTHONUNBUFFERED 1
RUN mkdir /root/testdjango/code    #都写上绝对路径
WORKDIR /root/testdjango/code
ADD requirements.txt /root/testdjango/code/
RUN pip install -r requirements.txt
ADD . /root/testdjango/code/
python 的pip 有一个requirements.txt 文件来专门放依赖环境的

django 环境搭建
requirements.txt

Django
psycopg2
docker-compose.yml 写作
db:
  image: postgres
web:
  build: .
  command: python manage.py runserver 0.0.0.0:8000
  volumes:
    - .:/code
  ports:
    - "8000:8000"
  links:
    - db
django 构建工程
docker-compose run web django-admin.py startproject docker_composeexample .

django 数据库设定
我们做了 volumes， django 的东西在本地有映射。
做过 django 的人都知道 ，我们的设定都在 settings.py 中

root@ubuntu:~/testdjango/docker_composeexample# cat settings.py 
"""
Django settings for docker_composeexample project.

Generated by 'django-admin startproject' using Django 1.10.6.

For more information on this file, see
https://docs.djangoproject.com/en/1.10/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/1.10/ref/settings/
"""

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/1.10/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = '3*@nbl2pu$hdmpe-hy&iko_cr_-$%9g=nu2=3x_^g(vy2463d6'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'docker_composeexample.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'docker_composeexample.wsgi.application'


# Database
# https://docs.djangoproject.com/en/1.10/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/1.10/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/1.10/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/1.10/howto/static-files/

STATIC_URL = '/static/'
root@ubuntu:~/testdjango/docker_composeexample# 
我们只设置 数据库

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'postgres',
        'USER': 'postgres',
        'HOST': 'db',
        'PORT': 5432,
    }
}
开始运行
docker-compose up

数据库同步
docker-compose run web python manage.py syncdb
```
---
##### [docker-compose.yaml]
```
version: "3.3"
services:
  zlktest1:
    image: zlktest
    container_name: zlktest1
    ports:
      - 80:8000
    expose:
      - "8000"
    entrypoint: ["python", "main.py"]
```

## 参考博客及文章
docker-中文手册
http://www.docker.org.cn/book/docker/what-is-docker-16.html
使用docker-compose 来部署服务
https://www.cnblogs.com/neptunemoon/p/6512121.html
docker之Dockerfile指令介绍
https://www.cnblogs.com/jsonhc/p/7766841.html
docker之Dockerfile实践
https://www.cnblogs.com/jsonhc/p/7767669.html
docker之手动构建新的镜像
https://www.cnblogs.com/jsonhc/p/7766561.html
Docker 命令大全
http://www.runoob.com/docker/docker-command-manual.html